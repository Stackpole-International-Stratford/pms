{% extends "barcode/base.html" %}
{% load widget_tweaks %}
{% block title %}Barcode Verify{% endblock %}

{% block extra_styles %}
{% endblock %}

{% block content %}
<div class="col-12">
    <h1 class="fw-bolder text-center" id="page_title">{{ title }}</h1>
</div>
<div class="col-12">
    <hr>
</div>

<div class="row d-flex justify-content-center input-control-lg align-items-center mb-3">
    <div class="col-8">
        <label for="scan_input">Barcode</label>
        <input type="text" class="form-control" id="scan_input"/>
    </div>
    <div class="col">
        <label for="running_count">Count</label>
        <input type="text" class="form-control" id="running_count"/>
    </div>
</div>
<form id="main_form" class="row d-flex justify-content-center" action="" method="POST">
    {% csrf_token %}
    <div class="row d-flex justify-content-center input-control-lg mb-3">
        <div class="col-auto">
            <ul id="visible_list"></ul>
            <!-- {{ form.barcodes|add_class:"form-control"|attr:"placeholder:Scan Barcode" |attr:"hidden"}} -->
            {{ form.barcodes|add_class:"form-control"|attr:"placeholder:Scan Barcode"}}
        </div>
    </div>
    <div class="row d-flex justify-content-center input-control-lg mb-3">
        <div class="col-auto">
            <button class="btn btn-primary" type="button" id="submit_button" name="btnsubmit" onclick="submitBarcodeList()" >Submit</button>
            <button class="btn btn-secondary" type="button" onclick="clearInput()" id="clear_button" >Clear</button>
        </div>
    </div>
    <div class="row d-flex justify-content-center input-control-lg mb-3">
        <div class="col-auto">
            <h4>Current Part:</h4>
        </div>
        <div class="col-auto">
            <select class="form-select" name="part_select" aria-label="Part Selector" onChange="autoSubmit()" id="part_select">
                {% for option in part_select_options %}
                <option value="{{ option.id }}" {% if option.id == active_part %} selected {% endif %}>
                    {{ option.name }}
                </option>
                {% endfor %}
            </select>
        </div>
    </div>
</form>

<!-- Execution time 
<div class="col-12">
    <h5 class="fw-bolder text-center">Execution Time: {{ timer }}</h5>
</div>  -->

{% endblock %}

{% block extra_js %}
<script data-active_part_prefix = "{{active_part_prefix}}"
        data-parts_per_tray = "{{parts_per_tray}}">
    const data = document.currentScript.dataset
    var barcode_list = new Array()

    const scanner_input_textbox = document.getElementById("scan_input")
    const barcodes_textbox = document.getElementById("id_barcodes")
    const visible_list = document.getElementById("visible_list")
    const running_count = document.getElementById("running_count")
    const form = document.getElementById("main_form");
    const submit_button = document.getElementById("submit_button")

    // On first page load and any successive cache loads, focuses barcode input and disables submit button
    window.onpageshow = function() {
        scanner_input_textbox.focus()
        submit_button.setAttribute('disabled', true)
        scanner_input_textbox.removeAttribute('disabled')
    }
    
    // submits the form when the part type dropdown changes
    // sets the part type value and loads the correct part specific values
    function autoSubmit(){
        form.submit()
    }

    function submitBarcodeList(){
        for (barcode of barcode_list){
            barcodes_textbox.value += barcode + "\n"
        }

        form.submit()
    }

    function clearInput(event){
        console.log("clear input")
        barcode_list.length = 0
        update_list()
    }

    function processScan(event) {
        console.log(scanner_input_textbox.value)
        console.log(data.active_part_prefix)

        const scanned_code = scanner_input_textbox.value

        // Skips if already scanned in skid
        if (barcode_list.includes(scanned_code)){
            console.log("found duplicate");
            return
        }
        barcode_list.push(scanned_code)

        update_list()
        
        // clear the input for next scan
        scanner_input_textbox.value = ""
    }

    function update_list(){
        // blank the list
        visible_list.innerHTML = ""
        // build new list if there are any elements
        if (barcode_list.length){
            barcode_list.sort()
            for (barcode of barcode_list){
                let list_item = document.createElement('li');
                list_item.appendChild(document.createTextNode(barcode));
                if (!barcode.startsWith(data.active_part_prefix)){
                    list_item.classList.add("text-danger")
                }
                visible_list.appendChild(list_item);
            }
        }
        // Updates count
        running_count.value = barcode_list.length.toString() + " of " + data.parts_per_tray.toString()   

        // Enable button once correct count is reached
        if(barcode_list.length === parseInt(data.parts_per_tray)){
            submit_button.removeAttribute('disabled')
            scanner_input_textbox.setAttribute('disabled', true)
        }

    }

    scanner_input_textbox.addEventListener("change", processScan, true)

</script>
{% endblock %}